#!/usr/bin/env bash

cmd="$1"
st="$2"
if [[ -z "$cmd" ]];then
  echo "set cmd"
  exit 1
fi

shift;shift
if [[ $# -ge 1 ]];then
  echo $ gcloud compute $cmd "$@"
  if [ "$cmd" = "instances delete" ];then
    echo y|gcloud compute $cmd "$@"
  else
    gcloud compute $cmd "$@"
  fi
  exit $?
fi

if [ -n "$st" ];then
  instances="$(gcloud compute instances list|grep "${st}$")"
else
  instances="$(gcloud compute instances list|grep -v "STATUS$")"
fi

tool=""
for t in $(echo ${GCE_SELECTION_TOOL:-peco,fzy,fzf,sentaku}|tr , ' ');do
  if type "$t" >& /dev/null ;then
    tool=$t
  fi
done
if [[ "$tool" = "sentaku" ]];then
  tool="sentaku -s line"
fi
if [ -n "$tool" ];then
  selected=$(echo "${instances}"|$tool)
else
  orig_ifs=$IFS
  IFS=$'\n'
  instances=($(echo "$instances"))
  IFS=$orig_ifs

  select instance in "${instances[@]}";do
    selected=$instance
    echo
    break
  done
fi

if [[ -z "${selected}" ]];then
  exit
fi

orig_ifs=$IFS
IFS=$'\n'
instances=(${selected})
IFS=$orig_ifs
for i in "${instances[@]}";do
  instance=($i)
  echo $ gcloud compute $cmd "${instance[0]}" --zone "${instance[1]}"
  if [[ "$cmd" = *delete ]];then
    echo y|gcloud compute $cmd "${instance[0]}" --zone "${instance[1]}"
  else
    gcloud compute $cmd "${instance[0]}" --zone "${instance[1]}"
  fi
done
