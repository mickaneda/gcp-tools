#!/usr/bin/env bash

if [ $# -lt 2 ];then
  echo "Usage: gce make_image <input instance name> <output image name>"
  exit 1
fi
input="$1"
output="$2"

instance=($(gcloud compute instances list|grep "^$input "))

if [ "${#instance[@]}" -eq 0 ];then
  echo "$input is not available"
  exit 1
fi

zone="${instance[1]}"

exec_cmd () {
  cmd="$*"
  echo "$ $cmd"
  eval "$cmd"
  ret=$?
  if [ $ret -ne 0 ];then
    echo "Failed"
    exit $ret
  fi
}
exec_cmd gcloud compute disks snapshot "$input" --snapshot-names "$input" --zone "$zone"
exec_cmd gcloud compute disks create "$output" --source-snapshot "$input" --zone "$zone"
exec_cmd gcloud compute images create "$output" --source-disk "$output" --source-disk-zone "$zone"
exec_cmd "echo y | gcloud compute snapshots delete $input"
exec_cmd "echo y | gcloud compute disks delete $output --zone $zone"
